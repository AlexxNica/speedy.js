#/bin/bash

BINARYEN_PASSES=duplicate-function-elimination,dce,remove-unused-brs,remove-unused-names,optimize-instructions,pick-load-signs,precompute,code-pushing,simplify-locals-nostructure,vacuum,reorder-locals,remove-unused-brs,coalesce-locals,simplify-locals,vacuum,reorder-locals,remove-unused-brs,merge-blocks,optimize-instructions,precompute,local-cse,coalesce-locals,vacuum,duplicate-function-elimination,remove-unused-module-elements,memory-packing #EQUALS -O3

for i in ./cases/*.cc; do
    # Process $i
    echo "EMCC $i";

    filename=$(basename $i)
    ../runtime/tools/emscripten/em++ --em-config $(pwd)/../runtime/.emscripten --cache $(pwd)/../runtime/.emscripten_cache -O3 $i -o ${i%.cc}-emcc.js -std=c++11 -s EXPORTED_FUNCTIONS="[ '_${filename%.cc}' ]" -s INVOKE_RUN=0 -s BINARYEN_PASSES="'$BINARYEN_PASSES'" --pre-js ./cases/pre.js -s ALLOW_MEMORY_GROWTH=1

    if [ $? -ne 0 ]; then { echo "Failed, aborting." ; exit 1; } fi
done
